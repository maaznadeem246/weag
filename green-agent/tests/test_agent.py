"""A2A conformance tests for WEAG Green Agent."""
from typing import Any
import pytest
import httpx
from uuid import uuid4

from a2a.client import A2ACardResolver, ClientConfig, ClientFactory
from a2a.types import Message, Part, Role, TextPart


# A2A validation helpers

def validate_agent_card(card_data: dict[str, Any]) -> list[str]:
    """Validate the structure and fields of an agent card."""
    errors: list[str] = []
    required_fields = frozenset([
        'name', 'description', 'url', 'version', 'capabilities',
        'defaultInputModes', 'defaultOutputModes', 'skills',
    ])

    for field in required_fields:
        if field not in card_data:
            errors.append(f"Required field is missing: '{field}'.")

    if 'url' in card_data and not (
        card_data['url'].startswith('http://') or card_data['url'].startswith('https://')
    ):
        errors.append("Field 'url' must be an absolute URL starting with http:// or https://.")

    if 'capabilities' in card_data and not isinstance(card_data['capabilities'], dict):
        errors.append("Field 'capabilities' must be an object.")

    for field in ['defaultInputModes', 'defaultOutputModes']:
        if field in card_data:
            if not isinstance(card_data[field], list):
                errors.append(f"Field '{field}' must be an array of strings.")
            elif not all(isinstance(item, str) for item in card_data[field]):
                errors.append(f"All items in '{field}' must be strings.")

    if 'skills' in card_data:
        if not isinstance(card_data['skills'], list):
            errors.append("Field 'skills' must be an array of AgentSkill objects.")
        elif not card_data['skills']:
            errors.append("Field 'skills' array is empty. Agent must have at least one skill.")

    return errors


def validate_event(data: dict[str, Any]) -> list[str]:
    """Validate an incoming event from the agent based on its kind."""
    if 'kind' not in data:
        return ["Response from agent is missing required 'kind' field."]

    kind = data.get('kind')
    
    if kind == 'task':
        errors = []
        if 'id' not in data:
            errors.append("Task object missing required field: 'id'.")
        if 'status' not in data or 'state' not in data.get('status', {}):
            errors.append("Task object missing required field: 'status.state'.")
        return errors
    
    elif kind == 'status-update':
        errors = []
        if 'status' not in data or 'state' not in data.get('status', {}):
            errors.append("StatusUpdate object missing required field: 'status.state'.")
        return errors
    
    elif kind == 'artifact-update':
        errors = []
        if 'artifact' not in data:
            errors.append("ArtifactUpdate object missing required field: 'artifact'.")
        elif (
            'parts' not in data.get('artifact', {})
            or not isinstance(data.get('artifact', {}).get('parts'), list)
            or not data.get('artifact', {}).get('parts')
        ):
            errors.append("Artifact object must have a non-empty 'parts' array.")
        return errors
    
    elif kind == 'message':
        errors = []
        if (
            'parts' not in data
            or not isinstance(data.get('parts'), list)
            or not data.get('parts')
        ):
            errors.append("Message object must have a non-empty 'parts' array.")
        if 'role' not in data or data.get('role') != 'agent':
            errors.append("Message from agent must have 'role' set to 'agent'.")
        return errors
    
    return [f"Unknown message kind received: '{kind}'."]


async def send_text_message(text: str, url: str, context_id: str | None = None, streaming: bool = False):
    """Send a text message to the agent and return events."""
    async with httpx.AsyncClient(timeout=30) as httpx_client:
        resolver = A2ACardResolver(httpx_client=httpx_client, base_url=url)
        agent_card = await resolver.get_agent_card()
        config = ClientConfig(httpx_client=httpx_client, streaming=streaming)
        factory = ClientFactory(config)
        client = factory.create(agent_card)

        msg = Message(
            kind="message",
            role=Role.user,
            parts=[Part(TextPart(text=text))],
            message_id=uuid4().hex,
            context_id=context_id,
        )

        events = [event async for event in client.send_message(msg)]

    return events


# A2A conformance tests

def test_agent_card(agent):
    """Validate agent card structure and required fields."""
    response = httpx.get(f"{agent}/.well-known/agent-card.json")
    assert response.status_code == 200, "Agent card endpoint must return 200"

    card_data = response.json()
    errors = validate_agent_card(card_data)

    assert not errors, f"Agent card validation failed:\n" + "\n".join(errors)


@pytest.mark.asyncio
@pytest.mark.parametrize("streaming", [True, False])
async def test_message_format(agent, streaming):
    """Test that agent returns valid A2A message format."""
    test_request = {
        "participants": {"test_agent": "http://localhost:9010"},
        "config": {"task": "miniwob.click-test"}
    }
    import json
    events = await send_text_message(json.dumps(test_request), agent, streaming=streaming)

    all_errors = []
    for event in events:
        match event:
            case Message() as msg:
                errors = validate_event(msg.model_dump())
                all_errors.extend(errors)

            case (task, update):
                errors = validate_event(task.model_dump())
                all_errors.extend(errors)
                if update:
                    errors = validate_event(update.model_dump())
                    all_errors.extend(errors)

            case _:
                pytest.fail(f"Unexpected event type: {type(event)}")

    assert events, "Agent should respond with at least one event"
    assert not all_errors, f"Message validation failed:\n" + "\n".join(all_errors)


@pytest.mark.asyncio
async def test_health_endpoint(agent):
    """Test that health endpoint responds correctly."""
    async with httpx.AsyncClient() as client:
        response = await client.get(f"{agent}/health")
        assert response.status_code == 200, "Health endpoint should return 200"
        data = response.json()
        assert "status" in data, "Health response should contain status field"
